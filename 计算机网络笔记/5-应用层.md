[TOC]



# 6.应用层

## 6.1 域名系统 DNS

域名的作用：负责解析域名，将域名解析成IP地址

- 许多应用层软件经常直接使用域名系统 DNS (Domain Name System)，但计算机的用户只是间接而不是直接使用域名系统。 

- 因特网采用层次结构的命名树作为主机的名字，并使用分布式的域名系统 DNS。

- 名字到 IP 地址的解析是由若干个域名服务器程序完成的。域名服务器程序在专设的结点上运行，运行该程序的机器称为域名服务器。  

域名解析测试：

nslookup www.91xueit.com

![image-20200811202615059](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/域名解析测试.png)



### 6.1.2 因特网的域名结构

- 因特网采用了层次树状结构的命名方法。
- 任何一个连接在因特网上的主机或路由器，都有一个唯一的层次结构的名字，即域名。
- 域名的结构由标号序列组成，各标号之间用点隔开：

​       … **.** 三级域名 **.** 二级域名 **.** 顶级域名

- 各标号分别代表不同级别的域名。 

如www.baidu.com

**顶级域名 TLD (Top Level Domain)**

(1) 国家顶级域名 nTLD：如: .cn 表示中国，.us 表示美国，.uk 表示英国，等等。

(2) 通用顶级域名 gTLD：最早的顶级域名是：

  .com （公司和企业）

  .net （网络服务机构）

  .org （非赢利性组织）

  .edu （美国专用的教育机构（）

  .gov （美国专用的政府部门）

  .mil  （美国专用的军事部门）

  .int   （国际组织）

因特网的域名空间 

![image-20200811200734951](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/因特网的域名空间.png)



### 6.1.3 域名服务器

域名的解析过程

![域名的解析过程](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/安装自己的域名服务器.png)

安装自己的域名服务器（需求）

1. 解析内网自己的域名
2. 降低到Internet的域名解析流量
3. 域环境

在打开的控制面板窗口，选择“网络和Internet项”图标，在打开的窗口中点击“查看网络状态和任务”快捷链接，点击“更改适配器设置”快捷链接，在打开的网络连接窗口，就可以看到电脑中本地连接的列表了，然后右键点击正在使用的本地链接，在弹出菜单中选择“属性”菜单项，在打开的本地连接属性窗口，找到“Internet协议4（TCP/IPV4）”项，双击该项，或是选择后点击“属性”按钮，在打开的属性设置窗口，选择“使用下面的IP地址”项，在下面输入你的IP地址、子网掩码及网关就可以了

![image-20200811204456933](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/域名的解析过程.png)



### DHCP协议- 动态主机配置

![DHCP协议- 动态主机配置](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/FTP主动模式与被动模式1.png)



在dos命令行下，使用  （在本网段自动分配地址）

> ipconfig /release   释放Ip租约
>
> ipconfig /renew	重新请求地址

跨网段自动分配地址使用到了DHCP中继代理，

- 并不是每个网络上都有 DHCP 服务器，这样会使 DHCP 服务器的数量太多。现在是每一个网络至少有一个 DHCP **中继代理**，它配置了 DHCP 服务器的 IP 地址信息。
- 当 DHCP 中继代理收到主机发送的发现报文后，就以**单播方式**向 DHCP 服务器转发此报文，并等待其回答。收到 DHCP 服务器回答的提供报文后，DHCP 中继代理再将此提供报文发回给主机。

**跨网段地址分配**

![跨网段地址分配](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/DHCP协议- 动态主机配置.png)

如图三个网段：192.168.1.0 、192.168.2.0 、192.168.3.0 只有一台DHCP服务器。可以更改如下配置使一台DHCP服务器给三个网段地计算机分配地址。

- 在DHCP服务器中创建三个网段：192.168.1 、 192.168.2 、 192.168.3 的作用域（地址池）。
- 在路由器的 6/1 和 6/0 端口分别配置如下命令：

> ip helper-address 192.168.1.9

这条命令便可实现跨网段的地址分配。注意要在路由器对应网段的端口处配置。192.168.1.9为DHCP服务器的地址。

配置了该命令的路由器也称为**DHCP中继代理**。

- **过程**
  192.168.1网段的计算机通过广播的形式向DHCP服务器请求地址；通过配置路由器中连接其他网段的端口上述命令，这些网段中的计算机可通过单播的形式通过路由器转发向DHCP服务器请求地址。

  DHCP服务器通过区分收到的请求地址信息是单播还是广播来判定是本网段计算机请求地址还是其他网段计算机请求地址。

  最后DHCP服务器从三个网段的地址池中选出地址分别分配给三个网段。

> **DHCP服务器必须是静态地址**

因为DHCP服务器是根据该静态地址为本网段的计算机分配地址的。

**补充**

可以发现计算机向本网段的DHCP服务器请求地址时采用的是广播的方式，相当于知道MAC地址请求IP地址。这与之前讲的ARP协议通过IP地址请求MAC地址正好相反，可以说是逆向ARP协议，即RARP（反向地址转换）协议。

## 6.2 文件传送协议（File Transfer Porofer Protocol）

### 6.2.1 FTP 概述

- **文件传送协议** FTP (File Transfer Protocol) 是因特网上使用得最广泛的文件传送协议。
- FTP 提供交互式的访问，允许客户指明文件的类型与格式，并允许文件具有存取权限。

### 6.2.2 FTP 的基本工作原理

**特点**

- 文件传送协议 FTP 只提供文件传送的一些基本的服务，它使用 **TCP** 可靠的运输服务。
- FTP 的主要功能是减少或消除在不同操作系统下处理文件的不兼容性。
- FTP 使用**客户服务器方式**。一个 FTP 服务器进程可同时为多个客户进程提供服务。FTP 的服务器进程由两大部分组成：一个**主进程**，负责接受新的请求；另外有若干个**从属进程**，负责处理单个请求，主进程与从属进程的处理是并发地进行。

**FTP传输模式**

- 文本模式：ASCII模式，以文本序列传输数据；
- 二进制模式：Binary模式，以二进制序列传输数据；

#### FTP 使用的两个 TCP 连接

![image-20200201151257498](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/跨网段地址分配.png)



- 第一个TCP连接为**控制连接**，客户端标准端口为21，用于发送FTP命令信息；
- 第二个TCP连接为**数据连接**， 服务器端标准端口为20，用于上传、下载数据。

数据连接的建立类型：

- **主动模式：**服务器端从**20端口**主动向客户端发起连接；
- **被动模式：**服务器端打开指定范围内的某个端口被动等待客户端发起连接。（此时服务器端不使用标准端口20）
- 客户进程使用**熟知端口(21)**与服务器进程建立控制连接；使用另一个端口建立数据连接。
- 服务器进程使用**熟知端口(20)**与客户进程所提供的端口建立数据传送连接；使用另一个端口与客户端进程建立控制连接。
- 由于 FTP 使用了两个不同的端口号，所以数据连接与控制连接不会发生混乱；在传输文件结束时客户端还可以利用控制连接发送请求终止传输信息。

#### FTP主动模式与被动模式

主动模式下防护墙需要打开21和20端口。ftp客户端告诉ftp服务器使用什么端口监听，ftp服务器和客户端的这个端口建立什么连接


![image-20200201154412140](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/FTP主动模式与被动模式2.png)

被动模式下ftp服务器只打开一个端口，等待ftp客户端的连接，ftp服务器，如果有防火墙，需要在防火墙开21和20的端口，使用主动模式进行数据连接。

![image-20200201154828739](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/FTP使用的两个TCP连接.png)

### 6.2.3 简单文件传送协议 TFTP

#### 特点

  (1) 每次传送的数据 PDU 中有 512 字节的数据，但最后一次可不足 512 字节。

  (2) 数据 PDU 也称为文件块(block)，每个块按序编号，从 1 开始。

  (3) 支持 ASCII 码或二进制传送。

  (4) 可对文件进行读或写。

  (5) 使用很简单的首部。 

- 发送完一个文件块后就等待对方的确认，确认时应指明所确认的块编号。

- 发完数据后在规定时间内收不到确认就要重发数据 PDU。

- 发送确认 PDU 的一方若在规定时间内收不到下一个文件块，也要重发确认 PDU。这样就可保证文件的传送不致因某一个数据报的丢失而告失败。 
- 在一开始工作时。TFTP 客户进程发送一个读请求 PDU 或写请求 PDU 给 TFTP 服务器进程，其熟知端口号码为 69。
- TFTP 服务器进程要选择一个新的端口和 TFTP 客户进程进行通信。
- 若文件长度恰好为 512 字节的整数倍，则在文件传送完毕后，还必须在最后发送一个只含首部而无数据的数据 PDU。
- 若文件长度不是 512 字节的整数倍，则最后传送数据 PDU 的数据字段一定不满512字节，这正好可作为文件结束的标志。



## 6.3 远程终端协议 TELNET

- TELNET 是一个简单的远程终端协议，也是因特网的正式标准。

- 用户用 TELNET 就可在其所在地通过 TCP 连接注册（即登录）到远地的另一个主机上（使用主机名或 IP 地址）。

- TELNET 能将用户的击键传到远地主机，同时也能将远地主机的输出通过 TCP 连接返回到用户屏幕。这种服务是透明的，因为用户感觉到好像键盘和显示器是直接连在远地主机上。 

#### 客户服务器方式

- TELNET 也使用客户服务器方式。在本地系统运行 TELNET 客户进程，而在远地主机则运行 TELNET 服务器进程。
- TELNET 使用网络虚拟终端 NVT 格式：

![NVT格式](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/NVT格式.png)

客户软件把用户的击键和命令转换成 NVT 格式，并送交服务器。

服务器软件把收到的数据和命令，从 NVT 格式转换成远地系统所需的格式。

向用户返回数据时，服务器把远地系统的格式转换为 NVT 格式，本地客户再从 NVT 格式转换到本地系统所需的格式。

#### 其他应用

可以使用telnet命令测试某计算机是否开启相应端口的服务，相当于端口扫描工具。

![image-20200812212319131](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/测试端口.png)

### 6.3.1 远程桌面RDP（Remote Desktop Protocol）

通过mstsc客户端远程连接计算机，并对其进行管理等操作。

与TELNET的区别在于，TELNET显示的是远程计算机的命令行窗口，而RDP为该计算机的图形界面，这样显得更加直观。

RDP=TCP+3389端口。

在运行界面输入mstsc，打开远程桌面登录界面，输入相应信息即可连接远程计算机。

Server是多用户操作系统，启用远程桌面可以多用户同时使用服务器。而Window xp和Window7是单用户系统，不能多个用户同时使用。

## 6.4 万维网 WWW

###   6.4.1 概述

- **万维网** WWW (World Wide Web)是一个大规模的、联机式的信息储藏所。
- 万维网用链接的方法能非常方便地从因特网上的一个站点访问另一个站点，从而主动地按需获取丰富的信息。
- 这种访问方式称为“**链接**”。
- 万维网提供分布式服务：

![万维网服务](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/万维网服务.png)



#### 超媒体与超文本

- 万维网是**分布式超媒体**(hypermedia)系统，它是**超文本**(hypertext)系统的扩充。
- 一个超文本由多个信息源链接成。利用一个链接可使用户找到另一个文档。这些文档可以位于世界上任何一个接在因特网上的超文本系统中。超文本是万维网的基础。
- 超媒体与超文本的区别是文档内容不同。超文本文档仅包含文本信息，而超媒体文档还包含其他表示方式的信息，如图形、图像、声音、动画，甚至活动视频图像。

#### 万维网的工作方式

- 万维网以**客户服务器**方式工作。
- **浏览器**就是在用户计算机上的万维网**客户程序**。万维网文档所驻留的计算机则运行**服务器程序**，因此这个计算机也称为**万维网服务器**。
- 客户程序向服务器程序发出请求，服务器程序向客户程序送回客户所要的万维网文档。
- 在一个客户程序主窗口上显示出的万维网文档称为**页面**(page)。



#### 万维网必须解决的问题

> 1.怎样标志分布在整个因特网上的万维网文档？

- 使用**统一资源定位符** URL (Uniform Resource Locator)来标志万维网上的各种文档。
- 使每一个文档在整个因特网的范围内具有唯一的标识符 URL。

> 2.用什么协议实现万维网上各种超链的链接？

- 在万维网客户程序与万维网服务器程序之间进行交互所使用的协议，是**超文本传送协议** HTTP (HyperText Transfer Protocol)。
- HTTP 是一个应用层协议，它使用 TCP 连接进行可靠的传送，一般使用80端口。

> 3.怎样使各种万维网文档都能在因特网上的各种计算机上显示出来，同时使用户清楚地知道在什么地方存在着超链？

- **超文本标记语言** HTML (HyperText Markup Language)使得万维网页面的设计者可以很方便地用一个超链从本页面的某处链接到因特网上的任何一个万维网页面，并且能够在自己的计算机屏幕上将这些页面显示出来。

###  6.4.2 统一资源定位符 URL

- 统一资源定位符 URL 是对可以从因特网上得到的资源的位置和访问方法的一种简洁的表示。
- URL 给资源的位置提供一种抽象的识别方法，并用这种方法给资源定位。

#### URL 的一般形式

- 由以冒号隔开的两大部分组成，并且在 URL 中的字符对大写或小写没有要求。
- URL 的一般形式是：

![URL 的一般形式](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/URL 的一般形式.png)

- "http"——表示使用HTTP协议；
- "：//"——冒号和两个左斜杠是规定的格式；
- "<主机>"——表示主机的域名；
- "<端口>"——HTTP的默认端口号是80，通常可省略；
- "<路径>"——表示文件路径，若再省略文件的<路径>项，则 URL 就指到因特网上的某个主页(home page)。



 ### 6.4.3 超文本传送协议 HTTP

#### HTTP 的操作过程

- 为了使超文本的链接能够高效率地完成，需要用 HTTP 协议来传送一切必须的信息。
- 从层次的角度看，HTTP 是**面向事务**的(transaction-oriented)应用层协议，它是万维网上能够可靠地交换文件（包括文本、声音、图像等各种多媒体文件）的重要基础。

#### HTTP 的报文结构

HTTP 有两类报文：

- 请求报文——从客户向服务器发送请求报文。
- 响应报文——从服务器到客户的回答。
- 由于 HTTP 是面向正文的(text-oriented)，因此在报文中的每一个字段都是一些 ASCII 码串，因而每个字段的长度都是不确定的。

#### HTTP 请求报文的结构

![HTTP请求报文的结构](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/HTTP请求报文的结构.png)



报文由三个部分组成，即**开始行**、**首部行**和**实体主体**。在请求报文中，开始行就是请求行。

- **方法**字段——对所请求的对象进行的操作，即一些命令。请求报文的类型是由它所采用的方法决定的；

  > HTTP 请求报文的一些方法

  - OPTION：请求一些选项的信息；
  - GET：请求读取由 URL所标志的信息；
  - HEAD：请求读取由 URL所标志的信息的首部；
  - POST：给服务器添加信息（例如，注释）；
  - PUT：在指明的 URL下存储一个文档；
  - DELETE：删除指明的 URL所标志的资源；
  - TRACE：用来进行环回测试的请求报文；
  - CONNECT：用于代理服务器；

- **URL**字段——所请求的资源的 URL；

- **版本**字段——表示 HTTP 的版本；



#### HTTP 响应报文的结构

![HTTP 响应报文的结构](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/HTTP 响应报文的结构.png)

响应报文的开始行是**状态行**。状态行包括三项内容，即 **HTTP 的版本**，**状态码**，以及解释状态码的简单**短语**。

- **状态码**

  状态码都由三个数字组成：

  - 1xx 表示通知信息的，如请求收到了或正在进行处理；
  - 2xx 表示成功，如接受或知道了；
  - 3xx 表示重定向，表示要完成请求还必须采取进一步的行动；
  - 4xx 表示客户的差错，如请求中有错误的语法或不能完成；
  - 5xx 表示服务器的差错，如服务器失效无法完成请求；

#### 超链接的工作过程

![超链接的工作过程](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/请求一个万维网文档所需的时间.png)

用户点击"链接"后所发生的事件 :

- 浏览器分析"文本"超链指向页面的 URL；

- 浏览器向 DNS 请求解析 www.123.edu.cn 的 IP 地址；

- 域名系统 DNS 解析出服务器的 IP 地址；

- 浏览器与服务器建立 TCP 连接

- 浏览器发出取文件命令：

  GET /chn/yxsz/index.htm。

- 服务器给出响应，把文件 index.htm 发给浏览器。

- TCP 连接释放。

- 浏览器显示“文本”文件 index.htm 中的所有文本。

#### 请求一个万维网文档所需的时间

![请求一个万维网文档所需的时间](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/超链接的工作过程.png)

RTT表示数据包（报文）往返时间。

#### 持续连接 (persistent connection)

- HTTP/1.1 协议使用持续连接。
- 万维网服务器在发送响应后仍然在一段时间内保持这条TCP连接，使同一个客户（浏览器）和该服务器可以继续在这条TCP连接上传送后续的 HTTP 请求报文和响应报文。
- 这并不局限于传送同一个页面上链接的文档，而是只要这些文档都在同一个服务器上就行。

#### 持续连接的两种工作方式

- **非流水线方式**：客户在收到前一个响应后才能发出下一个请求。与非持续连接相比节省了建立 TCP 连接所需的一个 RTT 时间。但服务器在发送完一个对象后，其 TCP 连接就处于空闲状态，浪费了服务器资源。
- **流水线方式**：客户在收到 HTTP 的响应报文之前就能够接着发送新的请求报文。一个接一个的请求报文到达服务器后，服务器就可连续发回响应报文。使用流水线方式时，客户访问所有的对象只需花费一个 RTT时间，使 TCP 连接中的空闲时间减少，提高了下载文档效率。

#### 在服务器上存放用户的信息

- 万维网站点使用 **Cookie** 来跟踪用户。
- Cookie 表示在 HTTP 服务器和客户之间传递的状态信息。
- 使用 Cookie 的网站服务器为用户产生一个唯一的识别码。利用此识别码，网站就能够跟踪该用户在该网站的活动。























 ###  6.4.4 代理服务器 (proxy server)

- **代理服务器**(proxy server)又称为万维网高速缓存(Web cache)，它代替浏览器发出 HTTP 请求；
- 可以在代理服务器中设置哪些网段的计算机能通过代理服务器上网，能通过代理服务器上什么网；
- 万维网高速缓存把最近的一些请求和响应暂存在本地磁盘中；
- 当与暂时存放的请求相同的新请求到达时，万维网高速缓存就把暂存的响应发送出去，而不需要按 URL 的地址再去因特网访问该资源。

#### 使用代理服务器的场合

> **1.节省内网访问 Internet 的带宽。**

安装代理服务器前：

![代理服务器；](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/安装代理服务器后.png)

内网的所有计算机上网的流量都通过这条2Mb/s的链路，这会造成该链路时延过大。

安装了代理服务器后：

- 浏览器访问因特网的服务器时，要先与校园网的代理服务器建立 TCP 连接，并向代理服务器发出 HTTP 请求报文。

![安装代理服务器后](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/代理服务器；.png)

- 若代理服务器已经存放了所请求的对象，则将此对象放入 HTTP 响应报文中返回给浏览器。

![使用了代理服务器后1](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/使用了代理服务器后1.png)

- 否则，代理服务器就代表发出请求的用户浏览器，与因特网上的源点服务器建立 TCP 连接，并发送 HTTP 请求报文。

![代理服务器与源点服务器建立TCP连接](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/代理服务器与源点服务器建立TCP连接.png)

- 源点服务器将所请求的对象放在 HTTP 响应报文中返回给校园网的代理服务器。

![返回给校园网的代理服务器。](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/绕过路由器的防火墙访问外网.png)



- 代理服务器收到此对象后，先复制在其本地存储器中（为今后使用），然后再将该对象放在 HTTP 响应报文中，通过已建立的 TCP 连接，返回给请求该对象的浏览器。

![返回给请求该对象的浏览器](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/返回给请求该对象的浏览器.png)

#### 绕过路由器的防火墙访问外网

- 路由器设置的防火墙会拦截目标地址或源地址为特定地址的数据包。
- 路由器只识别数据包的源地址和目标地址，不关心数据包内容。



![绕过路由器的防火墙访问外网](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/浏览器的结构.png)

如图所示，在国内的用户PC1想访问国外的某些网站时，路由器收到PC1的请求后，判断出目标地址为国外的某网于是路由器的防火墙截断了该请求，导致PC1无法成功访问；

如果PC1通过国外的代理服务器中转就可以访问外网。PC1发出的请求数据包目标地址为国外某代理服务器，请求数据包到达路由器时，路由器判断出数据包的目标地址不是防火墙设置的屏蔽地址，故能够把数据包传输给国外的代理服务器，代理服务器再把数据包传输给外网的源服务器；从外网返回的数据包通过代理服务器中转之后到达路由器时源地址变为代理服务器地址，故能绕开路由器的防火墙，成功到达PC1；由此PC1能够访问外网。

**避免IP地址被跟踪**

当我们在网上发表言论时，有时候隐藏个人计算机的IP地址能够带来很大便利。通过代理服务器在网络上进行活动能够有效地防止个人计算机地IP地址被跟踪。

原理为改变数据包地目标地址或源地址，过程与"上2"类似。



 ###  6.4.5 浏览器

浏览器就是在用户计算机上的万维网**客户程序**，相当于客户端。

#### 浏览器的结构

![浏览器的结构](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/返回给校园网的代理服务器。.png)

#### 浏览器中的缓存

- 浏览器将它取回的每一个页面副本都放入本地磁盘的缓存中。
- 当用户用点击某个超链接时，浏览器首先检查磁盘的缓存。若缓存中保存了超链接的URL指向的文件，浏览器就直接从缓存中得到该文件副本而不必从网络获取，这样就明显地改善浏览器的运行特性。 。
- 但缓存要占用磁盘大量的空间，而浏览器性能的改善只有在用户再次查看缓存中的页面时才有帮助。许多浏览器允许用户调整缓存策略。





 ##   6.5 电子邮件

 ### 6.5.1 电子邮件概述

- **电子邮件**(e-mail)是因特网上使用得最多的和最受用户欢迎的一种应用。
- 电子邮件把邮件发送到收件人使用的邮件服务器，并放在其中的收件人邮箱中，收件人可随时上网到自己使用的邮件服务器进行读取。

#### 1.1.电子邮件使用的协议

- 发送邮件的协议：**SMTP**
- 读取邮件的协议：**POP3** 和 **IMAP**
- **MIME** 在其邮件首部中说明了邮件的数据类型(如文本、声音、图像、视像等)，使用 MIME 可在邮件中同时传送多种类型的数据。

#### 1.2.发送电子邮件的过程

简略图例为：

![发送电子邮件的过程](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/发送电子邮件的过程详细图例.png)

- 如图用户x在qq服务器上注册了邮箱：x@qq.com；用户y在163服务器上注册了邮箱：y@163.com；这样qq服务器和163服务器就会分别给用户x和y分配一块空间，称为邮局，地址为他们的邮箱地址。邮局分为收件箱与发件箱。
- 用户需要在计算机上安装邮件服务器的客户端，比如：Fox mail。用户x使用Fox mail通过身份验证后可登录到个人的邮箱：x@qq.com，并可以下载收件箱中的邮件。
- 当用户x想发邮件给用户y时，在Fox mail中新建邮件，邮件的目标地址为：y@163.com，并放入其发件箱中。随后Fox mail把发件箱中的邮件通过SMTP协议发送到邮局的收件箱中。邮局：x@qq.com通过DNS服务器查找邮件交换机录找出邮局：y@163.com的IP地址，并通过发件箱使用SMTP协议发送到邮局：y@163.com的收件箱中。最后，用户y使用Fox mail通过身份验证后，使用POP3或IMAP协议从邮局：y@163.com的收件箱中下载邮件。由此用户y收到用户x发出的邮件。

详细图例为：



![发送电子邮件的过程详细图例](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/基于万维网的电子邮件.png)

- 用户代理 UA(User Agent) 就是用户与电子邮件系统的接口，是电子邮件客户端软件（如Fox mail）。
- 邮件服务器的功能是发送和接收邮件，同时还要向发信人报告邮件传送的情况（已交付、被拒绝、丢失等）。
- 邮件服务器按照客户服务器方式工作。邮件服务器需要使用发送和读取两个不同的协议。
- 一个邮件服务器收信时可作为服务器，发信时可作为客户。

> **几个重要步骤**

1.发件人调用 PC 机中的用户代理撰写和编辑要发送的邮件。

2.发件人的用户代理把邮件用 SMTP 协议发给发送方邮件服务器，

3.SMTP 服务器把邮件临时存放在邮件缓存队列中，等待发送。

4.发送方邮件服务器通过DNS服务器找到接收方邮件服务器地址后，其 SMTP 客户与接收方邮件服务器的 SMTP 服务器建立 TCP 连接，然后就把邮件缓存队列中的邮件依次发送出去。

5.运行在接收方邮件服务器中的SMTP服务器进 程收到邮件后，把邮件放入收件人的用户邮箱中，等待收件人进行读取。

6.收件人在打算收信时，就运行 PC 机中的用户代理，使用 POP3（或 IMAP）协议读取发送给自己的邮件。

**注意：**POP3 服务器和 POP3 客户之间的通信是由 POP3 客户发起的。

#### 1.3.电子邮件的组成

- 电子邮件由**信封**(envelope)和**内容**(content)两部分组成。
- 在邮件的信封上，最重要的就是收件人的地址。

#### 1.4.电子邮件地址的格式

- TCP/IP 体系的电子邮件系统规定电子邮件地址的格式如下：

  **收件人邮箱名@邮箱所在主机的域名 **

- 符号“@”读作“at”，表示“在”的意思。例如：电子邮件地址 Tom@qq.com 。"Tom"表示用户名，在该域名范围内是唯一的；qq.com"表示邮箱所在的主机的域名，必须是全世界唯一的。



 ### 6.5.2 简单邮件传送协议 SMTP

- SMTP 所规定的就是在两个相互通信的 SMTP 进程之间应如何交换信息。
- 由于 SMTP 使用客户服务器方式，因此负责发送邮件的 SMTP 进程就是 SMTP 客户，而负责接收邮件的 SMTP 进程就是 SMTP 服务器。
- SMTP 规定了 14 条命令和 21 种应答信息。每条命令用 4 个字母组成，而每一种应答信息一般只有一行信息，由一个 3 位数字的代码开始，后面附上（也可不附上）很简单的文字说明。

#### 2.1.SMTP 通信的三个阶段

1. 连接建立：连接是在发送主机的 SMTP 客户和接收主机的 SMTP 服务器之间建立的。SMTP不使用中间的邮件服务器。
2. 邮件传送
3. 连接释放：邮件发送完毕后，SMTP 应释放 TCP 连接。



 ### 6.5.3 邮件读取协议POP3 和 IMAP

#### 3.1.POP3协议

- 邮局协议 POP 是一个非常简单、但功能有限的邮件读取协议，现在使用的是它的第三个版本 POP3。
- POP 也使用客户服务器的工作方式。
- 在接收邮件的用户 PC 机中必须运行 POP 客户程序，而在用户所连接的 ISP 的邮件服务器中则运行 POP 服务器程序。

#### 3.2.IMAP 协议 (Internet Message Access Protocol)

- IMAP 也是按客户服务器方式工作，现在较新的是版本 4，即 IMAP4。
- 用户在自己的 PC 机上就可以操纵 ISP 的邮件服务器的邮箱，就像在本地操纵一样。
- IMAP 是一个联机协议。当用户 PC 机上的 IMAP 客户程序打开 IMAP 服务器的邮箱时，用户就可看到邮件的首部。

#### 3.3.IMAP 的特点

- IMAP最大的好处就是用户可以在不同的地方使用不同的计算机随时上网阅读和处理自己的邮件。
- IMAP 还允许收件人只读取邮件中的某一个部分。例如，收到了一个带有视像附件（此文件可能很大）的邮件。为了节省时间，可以先下载邮件的正文部分，待以后有时间再读取或下载这个很长的附件。
- IMAP 的缺点是如果用户没有将邮件复制到自己的 PC 机上，则邮件一直是存放在 IMAP 服务器上。因此用户需要经常与 IMAP 服务器建立连接。

**注意**

- 不要将邮件读取协议 POP 或 IMAP 与邮件传送协议 SMTP 弄混。
- 发信人的用户代理向源邮件服务器发送邮件，以及源邮件服务器向目的邮件服务器发送邮件，都是使用 SMTP 协议。
- 而 POP 协议或 IMAP 协议则是用户从目的邮件服务器上读取邮件所使用的协议。



 ### 6.5.4 基于万维网的电子邮件

![基于万维网的电子邮件](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/MIME 和 SMTP 的关系 .png)



- 电子邮件从 A 发送到网易邮件服务器是使用 HTTP 协议。
- 两个邮件服务器之间的传送使用 SMTP。
- 邮件从新浪邮件服务器传送到 B 是使用 HTTP 协议。

 ### 6.5.5 通用因特网邮件扩充 MIME 

> **MIME 概述**

SMTP 有以下缺点：

- SMTP 不能传送可执行文件或其他的二进制对象。
- SMTP 限于传送 7 位的 ASCII 码。许多其他非英语国家的文字（如中文、俄文，甚至带重音符号的法文或德文）就无法传送。
- SMTP 服务器会拒绝超过一定长度的邮件。
- 某些 SMTP 的实现并没有完全按照[RFC 821]的 SMTP 标准。

> **MIME 的特点**

- MIME 并没有改动 SMTP 或取代它。
- MIME 的意图是继续使用目前的[RFC 822]格式，但增加了邮件主体的结构，并定义了传送非 ASCII 码的编码规则

**MIME 和 SMTP 的关系 **

![MIME 和 SMTP 的关系 ](https://gitee.com/Fan_Yu_Feng/blogImage/raw/master/img/计算机网络/6-应用层/发送电子邮件的过程.png)

> **MIME 主要包括三个部分 **

- 5 个新的邮件首部字段，它们可包含在[RFC 822]首部中。这些字段提供了有关邮件主体的信息。
- 定义了许多邮件内容的格式，对多媒体电子邮件的表示方法进行了标准化。
- 定义了传送编码，可对任何内容格式进行转换，而不会被邮件系统改变。

> **MIME 增加 5 个新的邮件首部 **

- MIME-Version: 标志 MIME 的版本。现在的版本号是 1.0。若无此行，则为英文文本；
- Content-Description: 这是可读字符串，说明此邮件是什么。和邮件的主题差不多；
- Content-Id: 邮件的唯一标识符；
- Content-Transfer-Encoding: 在传送时邮件的主体是如何编码的；
- Content-Type: 说明邮件的性质；

> **MIME的内容传送编码 (Content-Transfer-Encoding) **

- 最简单的编码就是 7 位 ASCII 码，而每行不能超过 1000 个字符。MIME 对这种由 ASCII 码构成的邮件主体不进行任何转换。
- 另一种编码称为 quoted-printable，这种编码方法适用于当所传送的数据中只有少量的非 ASCII 码。
- 对于任意的二进制文件，可用 base64 编码。

> **MIME内容类型 **

- MIME的标准规定 Content-Type 说明必须含有两个标识符，即内容类型(type)和子类型(subtype)，中间用“/”分开。
- MIME 标准定义了 7 个基本内容类型和 15 种子类型。











  ### 

